<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Updates - Hello Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    
    <!-- PWA MANIFEST & ICONS -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1f2c24">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="https://i.ibb.co/zhxqCBkm/file-00000000572c7209af845b975946de46.png">

<!-- SERVICE WORKER REGISTRATION -->
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('service-worker.js')
                .then(reg => console.log('PWA Service Worker Registered'))
                .catch(err => console.log('Service Worker Error:', err));
        });
    }
</script>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#13ec5b", "background-dark": "#102216" },
                    fontFamily: { "display": ["Plus Jakarta Sans", "sans-serif"] }
                }
            }
        }
    </script>
</head>
<body class="bg-background-dark font-display text-white h-screen flex flex-col">

    <!-- STATUS VIEWER MODAL (Full Screen) -->
    <div id="statusModal" class="fixed inset-0 bg-black z-50 hidden flex-col justify-center items-center">
        <!-- Progress Bar -->
        <div class="absolute top-2 w-[95%] h-1 bg-gray-700 rounded-full overflow-hidden z-20">
            <div id="progressBar" class="h-full bg-white w-0 transition-all duration-[3000ms] ease-linear"></div>
        </div>

        <!-- Header -->
        <div class="absolute top-6 left-4 flex items-center gap-3 z-20">
            <span class="material-symbols-outlined text-white cursor-pointer drop-shadow-md" onclick="closeStatus()">arrow_back</span>
            <img id="viewerAvatar" src="" class="w-10 h-10 rounded-full border border-white">
            <div>
                <h4 id="viewerName" class="font-bold text-shadow text-sm">User</h4>
                <p id="viewerTime" class="text-xs text-gray-300">Just now</p>
            </div>
        </div>
        
        <!-- Main Image -->
        <img id="statusImage" src="" class="w-full h-auto max-h-screen object-contain">
        
        <!-- Caption -->
        <div id="statusCaptionContainer" class="absolute bottom-10 w-full text-center hidden">
            <p id="statusCaption" class="bg-black/60 px-4 py-2 rounded-full text-sm inline-block"></p>
        </div>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="statusInput" accept="image/*" class="hidden" onchange="uploadStatus(this)">

    <!-- Header -->
    <div class="bg-[#1A2B20] pt-4 pb-2 shadow-md z-10">
        <div class="flex justify-between items-center px-4 mb-4">
            <h1 class="text-2xl font-bold text-white tracking-tight">Updates</h1>
            <div class="flex gap-4 text-white">
                <span class="material-symbols-outlined cursor-pointer">photo_camera</span>
                <span class="material-symbols-outlined cursor-pointer">search</span>
                <span class="material-symbols-outlined cursor-pointer">more_vert</span>
            </div>
        </div>
        <div class="flex justify-between text-gray-400 text-sm font-bold uppercase">
            <div class="w-8 flex justify-center"><span class="material-symbols-outlined text-sm">groups</span></div>
            <div class="flex-1 text-center pb-2 cursor-pointer hover:text-white" onclick="window.location.replace('home.html')">Chats</div>
            <div class="flex-1 text-center border-b-2 border-primary text-primary pb-2">Updates</div>
            <div class="flex-1 text-center pb-2 cursor-pointer hover:text-white" onclick="window.location.replace('calls.html')">Calls</div>
        </div>
    </div>

    <!-- Content -->
    <div class="flex-1 overflow-y-auto p-4">
        <h3 class="text-lg font-bold mb-4">Status</h3>

        <!-- My Status -->
        <div class="flex items-center gap-4 mb-6 cursor-pointer" onclick="document.getElementById('statusInput').click()">
            <div class="relative">
                <img id="myAvatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="w-14 h-14 rounded-full border border-gray-600 object-cover">
                <div class="absolute bottom-0 right-0 bg-primary rounded-full p-1 border-2 border-[#102216] flex items-center justify-center">
                    <span class="material-symbols-outlined text-black text-sm font-bold">add</span>
                </div>
            </div>
            <div>
                <h4 class="font-bold text-lg">My Status</h4>
                <p id="myStatusText" class="text-gray-400 text-sm">Tap to add status update</p>
            </div>
        </div>

        <div class="border-t border-gray-700 my-4"></div>

        <h4 class="text-gray-400 text-sm font-bold mb-4">RECENT UPDATES</h4>
        <div id="recentUpdatesList" class="space-y-4">
            <p class="text-gray-500 text-sm text-center">Loading updates...</p>
        </div>
    </div>

    <!-- FAB -->
    <div class="absolute bottom-6 right-6 flex flex-col gap-4">
        <button class="w-12 h-12 bg-[#1f2c24] rounded-xl flex items-center justify-center shadow-lg text-white" onclick="alert('Text status coming soon')">
            <span class="material-symbols-outlined text-xl">edit</span>
        </button>
        <button onclick="document.getElementById('statusInput').click()" class="w-14 h-14 bg-primary rounded-2xl flex items-center justify-center shadow-lg transition transform hover:scale-110">
            <span class="material-symbols-outlined text-black text-2xl">photo_camera</span>
        </button>
    </div>

    <!-- 1. Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- 2. Firebase Config (Auth) -->
    <script type="module" src="firebase-config.js"></script>
    <!-- 3. Main Config -->
    <script src="supabase-config.js"></script>

    <script>
        let currentUser = null;

        async function initUpdates() {
            const session = await checkAuth();
            if(!session) { window.location.replace('login.html'); return; }
            currentUser = session.user;

            const { data: profile } = await window.supabase.from('profiles').select('avatar_url').eq('id', currentUser.id).single();
            if(profile && profile.avatar_url) document.getElementById('myAvatar').src = profile.avatar_url;

            loadRecentUpdates();
        }

        async function uploadStatus(input) {
            const file = input.files[0];
            if (!file) return;

            document.getElementById('myStatusText').innerText = "Uploading...";

            const fileName = `status_${currentUser.id}_${Date.now()}`;
            const { error: uploadError } = await window.supabase.storage.from('media').upload(fileName, file);

            if (uploadError) {
                alert("Upload failed: " + uploadError.message);
                return;
            }

            const { data: urlData } = window.supabase.storage.from('media').getPublicUrl(fileName);
            
            const { error: dbError } = await window.supabase.from('status').insert({
                user_id: currentUser.id,
                media_url: urlData.publicUrl,
                caption: "New update"
            });

            if(dbError) alert("DB Error: " + dbError.message);
            else {
                alert("Status Uploaded!");
                document.getElementById('myStatusText').innerText = "Tap to add status update";
                loadRecentUpdates();
            }
        }

        async function loadRecentUpdates() {
            const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
            
            const { data: statuses, error } = await window.supabase
                .from('status')
                .select('*, profiles(full_name, avatar_url)')
                .gt('created_at', yesterday)
                .order('created_at', { ascending: false });

            const list = document.getElementById('recentUpdatesList');
            list.innerHTML = '';

            if (statuses && statuses.length > 0) {
                statuses.forEach(status => {
                    // Don't show my own status in "Recent" list (Logic choice)
                    // if(status.user_id !== currentUser.id) {
                        renderStatusItem(status, list);
                    // }
                });
            } else {
                list.innerHTML = '<p class="text-gray-500 text-sm text-center">No recent updates.</p>';
            }
        }

        function renderStatusItem(status, container) {
            const div = document.createElement('div');
            div.className = "flex items-center gap-4 cursor-pointer hover:bg-[#1f3528] p-2 rounded-lg transition";
            div.onclick = () => viewStatus(status);
            
            const avatar = status.profiles.avatar_url || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
            const timeAgo = new Date(status.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            div.innerHTML = `
                <div class="rounded-full p-[2px] border-2 border-primary relative">
                    <img src="${avatar}" class="w-12 h-12 rounded-full border-2 border-[#102216] object-cover">
                </div>
                <div>
                    <h4 class="font-bold text-white capitalize">${status.profiles.full_name}</h4>
                    <p class="text-gray-400 text-sm">${timeAgo}</p>
                </div>
            `;
            container.appendChild(div);
        }

        let statusTimer;

        function viewStatus(status) {
            const modal = document.getElementById('statusModal');
            const bar = document.getElementById('progressBar');
            
            document.getElementById('statusImage').src = status.media_url;
            document.getElementById('viewerName').innerText = status.profiles.full_name;
            document.getElementById('viewerAvatar').src = status.profiles.avatar_url || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
            document.getElementById('viewerTime').innerText = new Date(status.created_at).toLocaleTimeString();

            if(status.caption) {
                document.getElementById('statusCaption').innerText = status.caption;
                document.getElementById('statusCaptionContainer').classList.remove('hidden');
            } else {
                document.getElementById('statusCaptionContainer').classList.add('hidden');
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Reset Animation
            bar.style.width = "0%";
            bar.style.transition = "none";
            
            setTimeout(() => {
                bar.style.transition = "width 3s linear";
                bar.style.width = "100%";
            }, 50);

            // Auto close after 3s
            clearTimeout(statusTimer);
            statusTimer = setTimeout(() => { closeStatus(); }, 3000);
        }

        function closeStatus() {
            clearTimeout(statusTimer);
            const modal = document.getElementById('statusModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        initUpdates();
    </script>
</body>
</html>
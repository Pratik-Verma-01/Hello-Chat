<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Hello Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700&display=swap" rel="stylesheet"/>
    
    <!-- PWA MANIFEST & ICONS -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1f2c24">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="https://i.ibb.co/zhxqCBkm/file-00000000572c7209af845b975946de46.png">

<!-- SERVICE WORKER REGISTRATION -->
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('service-worker.js')
                .then(reg => console.log('PWA Service Worker Registered'))
                .catch(err => console.log('Service Worker Error:', err));
        });
    }
</script>
    
    <!-- 1. Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- 2. Firebase Config (Module is Important) -->
    <script type="module" src="firebase-config.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#13ec5b", "background-dark": "#102216" },
                    fontFamily: { "display": ["Plus Jakarta Sans", "sans-serif"] }
                }
            }
        }
    </script>
</head>
<body class="bg-background-dark font-display text-white flex flex-col h-screen p-6 justify-center">

    <div class="w-full max-w-md mx-auto">
        <div class="text-center mb-10">
            <h1 id="pageTitle" class="text-3xl font-bold mb-2">Welcome Back</h1>
            <p id="pageSubtitle" class="text-gray-400 text-sm">Login to continue chatting.</p>
        </div>

        <div class="flex flex-col gap-4">
            <div>
                <label class="text-sm text-primary font-medium ml-1">Email</label>
                <input id="email" type="email" placeholder="name@example.com" 
                       class="w-full bg-[#1A2B20] border border-gray-600 text-white p-4 rounded-xl focus:border-primary focus:outline-none">
            </div>

            <div>
                <label class="text-sm text-primary font-medium ml-1">Password</label>
                <input id="password" type="password" placeholder="••••••••" 
                       class="w-full bg-[#1A2B20] border border-gray-600 text-white p-4 rounded-xl focus:border-primary focus:outline-none">
            </div>

            <div id="confirmDiv" class="hidden">
                <label class="text-sm text-primary font-medium ml-1">Confirm Password</label>
                <input id="confirmPassword" type="password" placeholder="••••••••" 
                       class="w-full bg-[#1A2B20] border border-gray-600 text-white p-4 rounded-xl focus:border-primary focus:outline-none">
            </div>

            <button onclick="handleAuth()" id="authBtn"
                    class="w-full bg-primary text-black font-bold text-lg p-4 rounded-full mt-4 shadow-lg active:scale-95 transition-transform">
                Login
            </button>

            <p class="text-center text-gray-400 text-sm mt-4 cursor-pointer hover:text-white" onclick="toggleMode()">
                <span id="toggleText">New here? Create an account</span>
            </p>
        </div>
    </div>

    <!-- 3. Supabase Config (Last mein load karein) -->
    <script src="supabase-config.js"></script>

    <script>
        let isSignup = false;

        function toggleMode() {
            isSignup = !isSignup;
            const title = document.getElementById('pageTitle');
            const sub = document.getElementById('pageSubtitle');
            const btn = document.getElementById('authBtn');
            const toggle = document.getElementById('toggleText');
            const confirmDiv = document.getElementById('confirmDiv');

            if (isSignup) {
                title.innerText = "Create Account";
                sub.innerText = "Sign up to get started.";
                btn.innerText = "Sign Up";
                toggle.innerText = "Already have an account? Login";
                confirmDiv.classList.remove('hidden');
            } else {
                title.innerText = "Welcome Back";
                sub.innerText = "Login to continue chatting.";
                btn.innerText = "Login";
                toggle.innerText = "New here? Create an account";
                confirmDiv.classList.add('hidden');
            }
        }

        async function handleAuth() {
            // Safety Check: Kya Firebase load hua?
            if (typeof window.createUserWithEmailAndPassword !== 'function') {
                alert("Please wait, system is loading...");
                console.log("Firebase not loaded yet.");
                return;
            }

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const confirm = document.getElementById('confirmPassword').value.trim();
            const btn = document.getElementById('authBtn');

            if (!email || !password) return alert("Please fill all fields");
            if (password.length < 6) return alert("Password must be at least 6 characters");

            btn.innerText = "Processing...";
            btn.disabled = true;

            try {
                if (isSignup) {
                    // --- SIGN UP ---
                    if (password !== confirm) {
                        throw new Error("Passwords do not match!");
                    }

                    const userCredential = await window.createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                    console.log("Created user:", userCredential.user.uid);
                    
                    // Sync to Supabase
                    if (typeof syncUserToSupabase === 'function') {
                        await syncUserToSupabase(userCredential.user);
                    }
                    window.location.replace('profile_setup.html');

                } else {
                    // --- LOGIN ---
                    const userCredential = await window.signInWithEmailAndPassword(window.firebaseAuth, email, password);
                    console.log("Logged in:", userCredential.user.uid);
                    
                    // Sync to Supabase just in case
                    if (typeof syncUserToSupabase === 'function') {
                        await syncUserToSupabase(userCredential.user);
                    }
                    window.location.replace('home.html');
                }

            } catch (error) {
                alert("Error: " + error.message);
                btn.innerText = isSignup ? "Sign Up" : "Login";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
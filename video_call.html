<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Call - Hello Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
</head>
<body class="bg-black h-screen w-full relative overflow-hidden">

    <!-- Remote Video (Full Screen) -->
    <video id="remoteVideo" autoplay playsinline class="absolute inset-0 w-full h-full object-cover bg-gray-900"></video>

    <!-- UI Overlay -->
    <div class="absolute top-0 left-0 right-0 p-6 bg-gradient-to-b from-black/70 to-transparent z-10 flex flex-col items-center">
        <h2 id="remoteName" class="text-xl font-bold text-white shadow-md">Connecting...</h2>
        <p id="callStatus" class="text-primary text-xs tracking-widest mt-1">SECURE CONNECTION</p>
    </div>

    <!-- Local Video (PiP) -->
    <div class="absolute top-20 right-4 w-32 h-48 bg-black rounded-xl border-2 border-white/20 overflow-hidden shadow-2xl z-20">
        <video id="localVideo" autoplay playsinline muted class="w-full h-full object-cover transform scale-x-[-1]"></video>
    </div>

    <!-- Controls -->
    <div class="absolute bottom-8 left-0 right-0 flex justify-center gap-6 z-30">
        <button onclick="toggleVideo()" class="w-14 h-14 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center text-white hover:bg-white/30">
            <span class="material-symbols-outlined text-2xl">videocam</span>
        </button>
        
        <button onclick="toggleAudio()" class="w-14 h-14 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center text-white hover:bg-white/30">
            <span class="material-symbols-outlined text-2xl">mic</span>
        </button>

        <button onclick="endCall()" class="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center text-white shadow-lg hover:scale-110 transition">
            <span class="material-symbols-outlined text-3xl">call_end</span>
        </button>
    </div>

    <script src="supabase-config.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const callId = urlParams.get('call_id');
        const servers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302'] }] };
        
        let localStream, peerConnection, currentUser;

        async function initVideoCall() {
            const { data: { user } } = await window.supabase.auth.getUser();
            if(!user) window.location.href = 'login.html';
            currentUser = user;

            if(!callId) return window.location.href = 'home.html';

            // Fetch Caller Name
            const { data: callData } = await window.supabase.from('calls').select('*').eq('id', callId).single();
            const otherId = callData.caller_id === currentUser.id ? callData.receiver_id : callData.caller_id;
            const { data: profile } = await window.supabase.from('profiles').select('full_name').eq('id', otherId).single();
            if(profile) document.getElementById('remoteName').innerText = profile.full_name;

            startWebRTC(callData);
        }

        async function startWebRTC(callData) {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = localStream;

                peerConnection = new RTCPeerConnection(servers);
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                peerConnection.ontrack = event => {
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                    document.getElementById('callStatus').innerText = "CONNECTED";
                };

                if (callData.caller_id === currentUser.id) {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    await window.supabase.from('calls').update({ sdp_offer: offer }).eq('id', callId);
                    
                    window.supabase.channel('video_signaling').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'calls', filter: `id=eq.${callId}` }, async (payload) => {
                        if(payload.new.sdp_answer && !peerConnection.currentRemoteDescription) {
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(payload.new.sdp_answer));
                        }
                    }).subscribe();
                } else {
                    if(callData.sdp_offer) await handleOffer(callData.sdp_offer);
                    else {
                        window.supabase.channel('video_signaling').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'calls', filter: `id=eq.${callId}` }, async (payload) => {
                            if(payload.new.sdp_offer && !peerConnection.currentRemoteDescription) await handleOffer(payload.new.sdp_offer);
                        }).subscribe();
                    }
                }

                // Listen for End Call
                window.supabase.channel('video_status').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'calls', filter: `id=eq.${callId}` }, (payload) => {
                    if(payload.new.status === 'ended') window.location.href = 'home.html';
                }).subscribe();

            } catch (e) {
                alert("Camera Access Denied");
                window.location.href = 'home.html';
            }
        }

        async function handleOffer(offer) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            await window.supabase.from('calls').update({ sdp_answer: answer, status: 'connected' }).eq('id', callId);
        }

        function toggleVideo() {
            const videoTrack = localStream.getVideoTracks()[0];
            videoTrack.enabled = !videoTrack.enabled;
        }

        function toggleAudio() {
            const audioTrack = localStream.getAudioTracks()[0];
            audioTrack.enabled = !audioTrack.enabled;
        }

        async function endCall() {
            localStream.getTracks().forEach(t => t.stop());
            await window.supabase.from('calls').update({ status: 'ended' }).eq('id', callId);
            window.location.href = 'home.html';
        }

        initVideoCall();
    </script>
</body>
</html>